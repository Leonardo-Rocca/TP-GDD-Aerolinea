/*
DROP TABLE DBAS.cancelaciones
DROP TABLE DBAS.canjes
DROP TABLE DBAS.pasajesEncomiendas
DROP TABLE DBAS.periodosFueraDeServicio
DROP TABLE DBAS.productos
DROP TABLE DBAS.rolesPorFuncionalidad
DROP TABLE DBAS.usuariosPorRol
DROP TABLE DBAS.usuarios
DROP TABLE DBAS.viajes
DROP TABLE DBAS.butacas
DROP TABLE DBAS.compras
DROP TABLE DBAS.funcionalidades
DROP TABLE DBAS.roles
DROP TABLE DBAS.rutas
DROP TABLE DBAS.aeronaves
DROP TABLE DBAS.ciudades
DROP TABLE DBAS.clientes
DROP TABLE DBAS.fabricantes
DROP TABLE DBAS.millas
DROP TABLE DBAS.servicios
DROP TABLE DBAS.personas


USE[GD2C2015];
GO
*/

/* -- Nuevo esquema -- */

CREATE SCHEMA [DBAS] AUTHORIZATION [gd];
GO

/* -- Tablas y Constraints -- */

-- DDL de tablas

CREATE TABLE DBAS.rutas (
	codigo_ruta bigint IDENTITY(1,1) PRIMARY KEY,
	codigo_ruta_original bigint,
	ciudad_origen_id bigint,
	ciudad_destino_id bigint,
	precio_base_por_KG float(24),
	precio_base_por_pasaje float(24),
	id_servicio bigint
);
GO

CREATE TABLE DBAS.viajes (
	id_viaje bigint IDENTITY(1,1) PRIMARY KEY,
	fecha_salida datetime,
	fecha_llegada datetime,
	fecha_llegada_estimada datetime,
	matricula_aeronave varchar(100),
	codigo_ruta bigint,
	CHECK( (fecha_llegada_estimada <= DATEADD(day, 1, fecha_salida)) AND (fecha_salida < fecha_llegada))
);
GO

CREATE TABLE DBAS.aeronaves (
	matricula_aeronave varchar(100) PRIMARY KEY,
	numero_aeronave bigint IDENTITY(1,1) UNIQUE,
	modelo_aeronave varchar(100),
	baja_fuera_de_servicio tinyint default 0,
	baja_vida_util tinyint default 0,
	fecha_reinsercion datetime,
	fecha_baja_servicio_definitiva datetime,
	kg_disponible_encomienda float(24),
	id_fabricante bigint,
 	id_servicio bigint

);
GO

CREATE TABLE DBAS.fabricantes (
	id_fabricante bigint IDENTITY(1,1) PRIMARY KEY,
	nombre_fabricante varchar(50)

);
GO

CREATE TABLE DBAS.butacas (
	id_butaca bigint IDENTITY(1,1) PRIMARY KEY,
	numero_butaca smallint,
	tipo_butaca varchar(15) CHECK(tipo_butaca IN('Pasillo','Ventanilla','0')),
	piso_butaca tinyint,
	matricula_aeronave varchar(100) NOT NULL,
	UNIQUE(numero_butaca, matricula_aeronave, piso_butaca)
);
GO

CREATE TABLE DBAS.pasajesEncomiendas (
	codigo_PE bigint IDENTITY(1,1) PRIMARY KEY,
	id_cliente  bigint,
	encomienda_cliente_KG float(24),
	id_viaje bigint NOT NULL,
	id_butaca bigint,
	fecha_compra_pasaje datetime NOT NULL,
	fecha_compra_encomienda datetime NOT NULL,
	precio_encomienda float(24),
	precio_pasaje float(24),
	id_compra_PNR bigint,
	id_cancelacion bigint
);
GO

CREATE TABLE DBAS.servicios (
	id_servicio bigint IDENTITY(1,1) PRIMARY KEY,
	porcentaje_arancel float(24),
	tipo_servicio varchar(50)
);
GO

CREATE TABLE DBAS.compras (
	id_compra_PNR bigint IDENTITY(1,1) PRIMARY KEY,
	id_cliente bigint
);
GO

CREATE TABLE DBAS.roles (
	id_rol bigint IDENTITY(1,1) PRIMARY KEY,
	nombre_rol varchar(100),
	habilitado_rol tinyint default 1
);
GO

CREATE TABLE DBAS.rolesPorFuncionalidad (
	id_rol bigint NOT NULL,
	id_funcionalidad bigint NOT NULL,
);
GO

CREATE TABLE DBAS.funcionalidades (
	id_funcionalidad bigint IDENTITY(1,1) PRIMARY KEY,
	descripcion varchar(100)
);
GO

CREATE TABLE DBAS.cancelaciones (
	id_cancelacion bigint IDENTITY(1,1) PRIMARY KEY,
	fecha_devolucion datetime,
	motivo_cancelacion varchar(100),
);
GO

CREATE TABLE DBAS.usuarios (
	id_usuario bigint PRIMARY KEY,
	username varchar(50) UNIQUE,
	password varchar(50),
	intentos_fallidos tinyint default 0,
	habilitado tinyint default 1,
	id_rol bigint
);
GO

CREATE TABLE DBAS.usuariosPorRol (
	id_usuario bigint NOT NULL,
	id_rol bigint NOT NULL
);
GO

CREATE TABLE DBAS.ciudades (
	id_ciudad bigint IDENTITY(1,1) PRIMARY KEY,
	nombre_ciudad varchar(100)
);
GO

CREATE TABLE DBAS.clientes (
	id_cliente bigint  IDENTITY(1,1) PRIMARY KEY,
	id_persona bigint NOT NULL,
	millas_totales bigint,
	id_millas bigint
);
GO

CREATE TABLE DBAS.personas (
	id_persona bigint IDENTITY(1,1) PRIMARY KEY,
	dni_persona bigint NOT NULL,
	nombre_persona varchar(100) NOT NULL,
	apellido_persona varchar(100) NOT NULL,
	direccion_persona varchar(100),
	telefono_persona varchar(50),
	mail_persona varchar(100),
	fecha_nacimiento datetime,
);
GO

CREATE TABLE DBAS.canjes (
	id_canje bigint IDENTITY(1,1) PRIMARY KEY,
	id_cliente bigint,
	fecha_canje datetime,
	cantidad_producto bigint,
	millas_usadas bigint,
	id_producto bigint
	
);
GO

CREATE TABLE DBAS.millas (
	id_millas bigint IDENTITY(1,1) PRIMARY KEY,
	valor_millas bigint,
	validez_millas int default 365,
	detalle_millas_realizadas varchar(100),
	
);
GO

CREATE TABLE DBAS.productos (
	id_producto bigint IDENTITY(1,1) PRIMARY KEY,
	valor_en_milas int,
	nombre_producto varchar(100),
	stock int
);
GO

CREATE TABLE DBAS.periodosFueraDeServicio (
	id_periodo bigint IDENTITY(1,1) PRIMARY KEY,
	matricula_aeronave varchar(100),
	fecha_fuera_servicio datetime,
	fecha_reinicio_servicio datetime
);
GO

--DDL de constraints compuestos

alter table DBAS.rolesPorFuncionalidad add constraint pk_rolesPorFuncionalidad 
	primary key clustered (id_rol, id_funcionalidad);
GO

alter table DBAS.usuariosPorRol add constraint pk_usuariosPorRol
	primary key clustered (id_usuario, id_rol);
GO

-- DDL de constraints FK

alter table DBAS.rutas add constraint fk_ruta_ciudadOrigen 
	foreign key (ciudad_origen_id) references DBAS.ciudades (id_ciudad);
GO

alter table DBAS.rutas add constraint fk_ruta_ciudadDestino 
	foreign key (ciudad_destino_id) references DBAS.ciudades (id_ciudad);
GO

alter table DBAS.rutas add constraint fk_ruta_servicio 
	foreign key (id_servicio) references DBAS.servicios (id_servicio);
GO

alter table DBAS.viajes add constraint fk_viaje_aeronave 
	foreign key (matricula_aeronave) references DBAS.aeronaves (matricula_aeronave);
GO	

alter table DBAS.viajes add constraint fk_viaje_ruta
	foreign key (codigo_ruta) references DBAS.rutas (codigo_ruta);
GO

alter table DBAS.aeronaves add constraint fk_aeronave_fabricante
	foreign key (id_fabricante) references DBAS.fabricantes (id_fabricante);
GO 
	
alter table DBAS.aeronaves add constraint fk_aeronave_servicio
	foreign key (id_servicio) references DBAS.servicios (id_servicio);
GO 

alter table DBAS.butacas add constraint fk_butaca_aeronave
	foreign key (matricula_aeronave) references DBAS.aeronaves (matricula_aeronave);
GO

alter table DBAS.pasajesEncomiendas add constraint fk_pasaje_cliente
	foreign key (id_cliente) references DBAS.clientes (id_cliente); 
GO

alter table DBAS.pasajesEncomiendas add constraint fk_pasaje_butaca
	foreign key (id_butaca) references DBAS.butacas (id_butaca);
GO

alter table DBAS.pasajesEncomiendas add constraint fk_pasaje_compra
	foreign key (id_compra_PNR) references DBAS.compras (id_compra_PNR);
GO

alter table DBAS.pasajesEncomiendas add constraint fk_pasaje_viaje
	foreign key (id_viaje) references DBAS.viajes (id_viaje);
GO

alter table DBAS.pasajesEncomiendas add constraint fk_pasaje_cancelacion
	foreign key (id_cancelacion) references DBAS.cancelaciones (id_cancelacion);
GO

alter table DBAS.compras add constraint fk_compra_cliente
	foreign key (id_cliente ) references DBAS.clientes (id_cliente);
GO

alter table DBAS.clientes add constraint fk_cliente_persona
	foreign key (id_persona) references DBAS.personas (id_persona);
GO

alter table DBAS.clientes add constraint fk_cliente_millas
	foreign key (id_millas) references DBAS.millas (id_millas);
GO

alter table DBAS.canjes add constraint fk_canje_cliente
	foreign key (id_cliente) references DBAS.clientes (id_cliente);
GO

alter table DBAS.canjes add constraint fk_canje_producto
	foreign key (id_producto) references DBAS.productos (id_producto);
GO

alter table DBAS.periodosFueraDeServicio add constraint fk_periodos_aeronave
	foreign key (matricula_aeronave) references DBAS.aeronaves (matricula_aeronave);	
GO

alter table DBAS.usuarios add constraint fk_usuario_rol
	foreign key (id_rol) references DBAS.roles (id_rol);
GO

alter table DBAS.rolesPorFuncionalidad add constraint fk_rolesPorFuncionalidad_rol
	foreign key (id_rol) references DBAS.roles (id_rol);
GO

alter table DBAS.rolesPorFuncionalidad add constraint fk_rolesPorFuncionalidad_funcionalidad
	foreign key (id_funcionalidad) references DBAS.funcionalidades (id_funcionalidad);
GO

alter table DBAS.usuariosPorRol add constraint fk_usuariosPorRol_usuarios
	foreign key (id_usuario) references DBAS.usuarios (id_usuario);
GO

alter table DBAS.usuariosPorRol add constraint fk_usuariosPorRol_rol
	foreign key (id_rol) references DBAS.roles (id_rol);
GO

/* -- Migracion -- */

--Se migran los fabricante de la tabla Maestra
INSERT INTO DBAS.fabricantes(nombre_fabricante)
SELECT DISTINCT Aeronave_Fabricante 
FROM gd_esquema.Maestra
GO

--Se migran las ciudades destino y origen quedando solo las que no se repiten
INSERT INTO DBAS.ciudades(nombre_ciudad)
SELECT DISTINCT Ruta_Ciudad_Origen FROM gd_esquema.Maestra UNION SELECT DISTINCT Ruta_Ciudad_Destino FROM gd_esquema.Maestra
GO

--Se migran los servivios de la tabla maestra
INSERT INTO DBAS.servicios(tipo_servicio)
SELECT DISTINCT Tipo_Servicio FROM gd_esquema.Maestra
GO

--Se crea una tabla temporal para poder manejar el precio del pasaje y kg de la ruta para la migracion
CREATE TABLE DBAS.#temporalRutasOriginales(nom_ruta_orig varchar(100), nom_ruta_dest varchar(100), ruta_PP float(24), ruta_PKG float(24), ruta_servicio varchar(50));
GO

--Se insertan los valores que se necesitan de la tabla maestra
INSERT INTO #temporalRutasOriginales(nom_ruta_orig, nom_ruta_dest, ruta_PP, ruta_PKG, ruta_servicio)
SELECT DISTINCT tablaAux1.Ruta_Ciudad_Origen, tablaAux1.Ruta_Ciudad_Destino, tablaAux2.Ruta_Precio_BaseKG, tablaAux1.Ruta_Precio_BasePasaje, tablaAux1.Tipo_Servicio
		FROM ((SELECT DISTINCT Ruta_Codigo, Ruta_Ciudad_Origen, Ruta_Ciudad_Destino,Ruta_Precio_BasePasaje, Tipo_Servicio FROM gd_esquema.Maestra WHERE Ruta_Precio_BasePasaje > 0.00) tablaAux1
			JOIN (SELECT DISTINCT Ruta_Codigo,Ruta_Ciudad_Origen, Ruta_Ciudad_Destino,Ruta_Precio_BaseKG, Tipo_Servicio FROM gd_esquema.Maestra WHERE Ruta_Precio_BASEKG > 0.00) tablaAux2
				ON (tablaAux1.Ruta_Ciudad_Origen = tablaAux2.Ruta_Ciudad_Origen AND tablaAux1.Ruta_Ciudad_Destino = tablaAux2.Ruta_Ciudad_Destino))
GO

--Utilizando las tablas temporal, ciudades y servicios migro tantos los datos como las ids de las tablas en rutas
INSERT INTO DBAS.rutas(ciudad_origen_id, ciudad_destino_id, precio_base_por_KG, precio_base_por_pasaje, id_servicio)
SELECT tablaCiudades_orig.id_ciudad, tablaCiudades_dest.id_ciudad, tmpRutas.ruta_PKG, tmpRutas.ruta_PP, tablaServicios.id_servicio
FROM ((SELECT * FROM DBAS.ciudades) tablaCiudades_orig 
	JOIN  #temporalRutasOriginales tmpRutas ON ( tmpRutas.nom_ruta_orig = tablaCiudades_orig.nombre_ciudad)
		JOIN (SELECT * FROM DBAS.ciudades) tablaCiudades_dest ON ( tmpRutas.nom_ruta_dest = tablaCiudades_dest.nombre_ciudad) 
			JOIN (SELECT * FROM DBAS.servicios) tablaServicios ON (tmpRutas.ruta_servicio = tablaServicios.tipo_servicio))
GO

/*
-- sirve para saber si hay consistencia con el tipo de servicio de la aeronave
SELECT DISTINCT aux1.Aeronave_matricula, aux1.Aeronave_KG_Disponibles, aux1.Aeronave_Fabricante, aux1.Tipo_Servicio 
FROM ((SELECT Aeronave_matricula, Aeronave_KG_Disponibles, Aeronave_Fabricante, Tipo_Servicio FROM gd_esquema.Maestra) aux1 JOIN (SELECT Aeronave_matricula, Aeronave_KG_Disponibles, Aeronave_Fabricante, Tipo_Servicio FROM gd_esquema.Maestra) aux2 
ON (aux1.Aeronave_Matricula = aux2.Aeronave_Matricula AND aux1.Tipo_Servicio != aux2.Tipo_Servicio)) 

-- sirve para saber si hay consistencia con kg disponibles
SELECT DISTINCT aux1.Aeronave_matricula, aux1.Aeronave_KG_Disponibles, aux1.Aeronave_Fabricante, aux1.Tipo_Servicio 
FROM ((SELECT Aeronave_matricula, Aeronave_KG_Disponibles, Aeronave_Fabricante, Tipo_Servicio FROM gd_esquema.Maestra) aux1 JOIN (SELECT Aeronave_matricula, Aeronave_KG_Disponibles, Aeronave_Fabricante, Tipo_Servicio FROM gd_esquema.Maestra) aux2 
ON (aux1.Aeronave_Matricula = aux2.Aeronave_Matricula AND aux1.Aeronave_KG_Disponibles != aux2.Aeronave_KG_Disponibles)) 
*/

--Migro las aeronaves de la tabla Maestra, utilizando las tablas fabricantes y servicios para obtener sus ids
INSERT INTO DBAS.aeronaves(matricula_aeronave, modelo_aeronave, kg_disponible_encomienda, id_fabricante, id_servicio)
SELECT tablaAux.Aeronave_Matricula, tablaAux.Aeronave_Modelo, tablaAux.Aeronave_KG_Disponibles, tablaFab.id_fabricante, tablaServ.id_servicio
FROM ((SELECT DISTINCT Aeronave_matricula, Aeronave_KG_Disponibles, Aeronave_Fabricante, Aeronave_Modelo, Tipo_Servicio FROM gd_esquema.Maestra) tablaAux
	JOIN DBAS.fabricantes tablaFab ON (tablaFab.nombre_fabricante = tablaAux.Aeronave_Fabricante)
		JOIN DBAS.servicios tablaServ ON (tablaServ.tipo_servicio = tablaAux.Tipo_Servicio))
GO

--Creo una tabla temporal que va a ser de ayuda para la migracion de los pasajes y asi utilizar menos tabla y ganar tiempo de busqueda de las ids
CREATE TABLE DBAS.#temporalViajesConRutas(id_viaj bigint, codigo_rut bigint, nom_ruta_orig varchar(100), nom_ruta_dest varchar(100), fecha_salida datetime, fecha_llegada datetime, matricula_aeronave varchar(100));
GO

--Creo un trigger para la insercion de los valores en la tabla temporal una vez que se insertaron los viajes
CREATE TRIGGER DBAS.migrarDatosATemporalTrigger ON DBAS.viajes
AFTER INSERT
AS
BEGIN
	
	INSERT INTO #temporalViajesConRutas(id_viaj, codigo_rut, nom_ruta_orig, nom_ruta_dest, fecha_salida, fecha_llegada, matricula_aeronave)
	SELECT tablaViajes.id_viaje, tablaRutas.codigo_ruta, tablaCiudadOrig.nombre_ciudad, tablaCiudadDest.nombre_ciudad, tablaViajes.fecha_salida, tablaViajes.fecha_llegada, tablaViajes.matricula_aeronave 
	FROM ((SELECT id_viaje, fecha_salida, fecha_llegada, codigo_ruta, matricula_aeronave FROM inserted) tablaViajes
		JOIN (SELECT codigo_ruta, ciudad_origen_id, ciudad_destino_id FROM DBAS.rutas) tablaRutas
		ON (tablaViajes.codigo_ruta = tablaRutas.codigo_ruta)
			JOIN DBAS.ciudades tablaCiudadOrig ON (tablaRutas.ciudad_origen_id = tablaCiudadOrig.id_ciudad)
			JOIN DBAS.ciudades tablaCiudadDest ON (tablaRutas.ciudad_destino_id = tablaCiudadDest.id_ciudad))
END;
GO

--Inserto la cantidad de viajes de la tabla maestra
INSERT INTO DBAS.viajes (fecha_salida,fecha_llegada_estimada,fecha_llegada,matricula_aeronave,codigo_ruta)
SELECT tablaAux.FechaSalida, tablaAux.Fecha_LLegada_Estimada, tablaAux.FechaLLegada, tablaAux.Aeronave_Matricula, tablaRutas.codigo_ruta
FROM ((SELECT DISTINCT FechaSalida, Fecha_LLegada_Estimada, FechaLLegada, Aeronave_Matricula, Ruta_Ciudad_Origen, Ruta_Ciudad_Destino FROM gd_esquema.Maestra) tablaAux 
	JOIN DBAS.ciudades tablaciudad_orig ON (tablaciudad_orig.nombre_ciudad= tablaAux.Ruta_Ciudad_Origen)
		JOIN DBAS.ciudades tablaciudad_dest ON (tablaciudad_dest.nombre_ciudad = tablaAux.Ruta_Ciudad_Destino)
			JOIN DBAS.rutas tablaRutas ON (tablaRutas.ciudad_origen_id = tablaciudad_orig.id_ciudad AND tablaRutas.ciudad_destino_id = tablaciudad_dest.id_ciudad))
GO

--Inserto las butacas de cada avion de la tabla maestra
INSERT INTO DBAS.butacas (numero_butaca, tipo_butaca, piso_butaca, matricula_aeronave)
SELECT DISTINCT Butaca_Nro, Butaca_Tipo, Butaca_Piso, Aeronave_Matricula FROM gd_esquema.Maestra
GO

--Creo una tabla temporal con el fin de utilizarla como ayuda para la migracion de los pasajes y asi buscar menos ids y mejorar el tiempo de migracion
CREATE TABLE DBAS.#temporalPasajesDeClientes(id_cliente bigint, fecha_llegada datetime, fecha_salida datetime, ciudad_origen varchar(100), ciudad_destino varchar(100), Pasaje_Codigo bigint, Pasaje_Precio float(24), Pasaje_FechaCompra datetime, Paquete_Codigo bigint, Paquete_Precio float(24), Paquete_FechaCompra datetime, Paquete_KG float(24), Butaca_Nro smallint, Butaca_Piso tinyint, Aeronave_Matricula varchar(100));
GO

--Creo un trigger que sirve para asociar el id de un cliente con el de la persona y lo ordeno por su id para 
--asegurarme de que tanto el id del cliente como el de la persona sean identicos para asi utilizar 
--el id de la persona sin buscarlo en la tabla clientes para la migracion
CREATE TRIGGER DBAS.migrarClientesEnPersonaTrigger ON DBAS.personas
AFTER INSERT
AS
BEGIN
	INSERT INTO DBAS.clientes(id_persona)
	SELECT id_persona FROM inserted
	ORDER BY id_persona
END;
GO

--Creo un trigger en persona para asi una vez insertadas las personas utilizar sus id para la relacionar los pasajes de la maestra con el id del cliente que lo posee
CREATE TRIGGER DBAS.temporalPasajesDeClientestrigger ON DBAS.personas
AFTER INSERT
AS
BEGIN
	INSERT INTO #temporalPasajesDeClientes(id_cliente, fecha_llegada, fecha_salida, ciudad_origen, ciudad_destino, Pasaje_Codigo, Pasaje_Precio, Pasaje_FechaCompra, Paquete_Codigo, Paquete_Precio, Paquete_FechaCompra, Paquete_KG, Butaca_Nro, Butaca_Piso, Aeronave_Matricula)
	SELECT tablaPersona.id_persona, tablaMaestra.FechaLLegada, tablaMaestra.FechaSalida, tablaMaestra.Ruta_Ciudad_Origen, tablaMaestra.Ruta_Ciudad_Destino, tablaMaestra.Pasaje_Codigo, tablaMaestra.Pasaje_Precio, tablaMaestra.Pasaje_FechaCompra, tablaMaestra.Paquete_Codigo, tablaMaestra.Paquete_Precio, tablaMaestra.Paquete_FechaCompra, tablaMaestra.Paquete_KG, tablaMaestra.Butaca_Nro, tablaMaestra.Butaca_Piso, tablaMaestra.Aeronave_Matricula 
	FROM ((SELECT id_persona, dni_persona, nombre_persona, apellido_persona FROM inserted) tablaPersona
	JOIN (SELECT Cli_Dni, Cli_Apellido, Cli_Nombre, Pasaje_Codigo, Pasaje_Precio, Pasaje_FechaCompra, Paquete_Codigo, Paquete_Precio, Paquete_FechaCompra, Paquete_KG, Butaca_Nro, Butaca_Piso, FechaSalida, FechaLLegada, Ruta_Ciudad_Origen, Ruta_Ciudad_Destino, Aeronave_Matricula FROM gd_esquema.Maestra) tablaMaestra
	ON (tablaPersona.dni_persona = tablaMaestra.Cli_Dni AND tablaPersona.nombre_persona = tablaMaestra.Cli_Nombre AND tablaPersona.apellido_persona = tablaMaestra.Cli_Apellido))
END;
GO

--Migro las personas de la tabla maestra
INSERT INTO DBAS.personas(dni_persona, nombre_persona, apellido_persona, direccion_persona, telefono_persona, mail_persona, fecha_nacimiento)
SELECT DISTINCT Cli_Dni, Cli_Nombre, Cli_Apellido, Cli_Dir, Cli_Telefono, Cli_Mail, Cli_Fecha_Nac FROM gd_esquema.Maestra
GO

--Activo la insercion en la variable identity de la tabla
SET IDENTITY_INSERT DBAS.pasajesEncomiendas ON
GO

--Inserto los valores de las las tablas temporales que solo tengan pasajes y no encomiendas
INSERT INTO DBAS.pasajesEncomiendas(codigo_PE, id_cliente, encomienda_cliente_KG, precio_pasaje, precio_encomienda, fecha_compra_pasaje, fecha_compra_encomienda, id_viaje, id_butaca)
SELECT DISTINCT tablaTemporalPasajes.Pasaje_Codigo, tablaTemporalPasajes.id_cliente, tablaTemporalPasajes.Paquete_KG, tablaTemporalPasajes.Pasaje_Precio, tablaTemporalPasajes.Paquete_Precio, tablaTemporalPasajes.Pasaje_FechaCompra, tablaTemporalPasajes.Paquete_FechaCompra, tablaTemporalViajes.id_viaj, tablaButacas.id_butaca 
FROM ((SELECT id_cliente, fecha_llegada, fecha_salida, ciudad_origen, ciudad_destino, Pasaje_Codigo, Pasaje_Precio, Pasaje_FechaCompra, Paquete_Codigo, Paquete_Precio, Paquete_FechaCompra, Paquete_KG, Butaca_Nro, Butaca_Piso, Aeronave_Matricula FROM #temporalPasajesDeClientes WHERE Butaca_Piso != 0) tablaTemporalPasajes
	JOIN DBAS.butacas tablaButacas ON (tablaTemporalPasajes.Aeronave_Matricula = tablaButacas.matricula_aeronave AND tablaTemporalPasajes.Butaca_Nro = tablaButacas.numero_butaca AND tablaTemporalPasajes.Butaca_Piso = tablaButacas.piso_butaca)
	JOIN #temporalViajesConRutas tablaTemporalViajes ON (tablaTemporalViajes.nom_ruta_orig = tablaTemporalPasajes.ciudad_origen AND tablaTemporalViajes.nom_ruta_dest = tablaTemporalPasajes.ciudad_destino AND tablaTemporalViajes.fecha_salida = tablaTemporalPasajes.fecha_salida AND tablaTemporalViajes.fecha_llegada = tablaTemporalPasajes.fecha_llegada AND tablaTemporalPasajes.Aeronave_Matricula = tablaTemporalViajes.matricula_aeronave))
GO

--Inserto los valores de las las tablas temporales que solo tengan encomiendas y no pasajes
INSERT INTO DBAS.pasajesEncomiendas(codigo_PE, id_cliente, encomienda_cliente_KG, precio_pasaje, precio_encomienda, fecha_compra_pasaje, fecha_compra_encomienda, id_viaje, id_butaca)
SELECT DISTINCT tablaTemporalPasajes.Paquete_Codigo, tablaTemporalPasajes.id_cliente, tablaTemporalPasajes.Paquete_KG, tablaTemporalPasajes.Pasaje_Precio, tablaTemporalPasajes.Paquete_Precio, tablaTemporalPasajes.Pasaje_FechaCompra, tablaTemporalPasajes.Paquete_FechaCompra, tablaTemporalViajes.id_viaj, tablaButacas.id_butaca 
FROM ((SELECT id_cliente, fecha_llegada, fecha_salida, ciudad_origen, ciudad_destino, Pasaje_Codigo, Pasaje_Precio, Pasaje_FechaCompra, Paquete_Codigo, Paquete_Precio, Paquete_FechaCompra, Paquete_KG, Butaca_Nro, Butaca_Piso, Aeronave_Matricula FROM #temporalPasajesDeClientes WHERE Butaca_Piso = 0) tablaTemporalPasajes
	JOIN DBAS.butacas tablaButacas ON (tablaTemporalPasajes.Aeronave_Matricula = tablaButacas.matricula_aeronave AND tablaTemporalPasajes.Butaca_Nro = tablaButacas.numero_butaca AND tablaTemporalPasajes.Butaca_Piso = tablaButacas.piso_butaca)
	JOIN #temporalViajesConRutas tablaTemporalViajes ON (tablaTemporalViajes.nom_ruta_orig = tablaTemporalPasajes.ciudad_origen AND tablaTemporalViajes.nom_ruta_dest = tablaTemporalPasajes.ciudad_destino AND tablaTemporalViajes.fecha_salida = tablaTemporalPasajes.fecha_salida AND tablaTemporalViajes.fecha_llegada = tablaTemporalPasajes.fecha_llegada AND tablaTemporalPasajes.Aeronave_Matricula = tablaTemporalViajes.matricula_aeronave))
GO

--Activo el identity para que se genere automaticamente nuevamente
SET IDENTITY_INSERT DBAS.pasajesEncomiendas OFF
GO

DROP TABLE #temporalPasajesDeClientes
GO

DROP TABLE #temporalViajesConRutas
GO

DROP TABLE #temporalRutasOriginales
GO

DROP TRIGGER DBAS.temporalPasajesDeClientestrigger
GO

DROP TRIGGER DBAS.migrarDatosATemporalTrigger
GO

DROP TRIGGER DBAS.migrarClientesEnPersonaTrigger
GO

/* Roles y funcionalidades */

-- Se agregan las funcionalidades
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('ABM de Rol');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Registro de Usuario');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('ABM de Ciudades');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('ABM de Ruta Aerea');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('ABM de Aeronaves');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Generar Viaje'); 
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Registro de llegada Destino');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Compra de Pasaje/Encomienda');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Cancelación/Devolución de pasaje y/o encomienda');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Consulta de millas de pasajero frecuente');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Canje de millas de pasajero frecuente');
INSERT INTO DBAS.funcionalidades (descripcion) VALUES ('Listado Estadístico');
GO

-- insercion del rol administrador
INSERT INTO DBAS.roles(nombre_rol) VALUES('Administrador General');
GO

-- Se agregan funcionalidades al rol administrador
INSERT INTO DBAS.rolesPorFuncionalidad(id_rol, id_funcionalidad)
select tablaRol.id_rol, tablaFuncionalidad.id_funcionalidad from DBAS.roles  tablaRol, DBAS.funcionalidades tablaFuncionalidad
where tablaRol.nombre_rol = 'Administrador General'
GO

-- Se agregan usuarios administradores
INSERT INTO DBAS.personas(dni_persona,apellido_persona,nombre_persona)
VALUES(99999999,'Admin','Admin')

DECLARE @id_p bigint
SET @id_p = SCOPE_IDENTITY()

-- Se inserta el usuario admin, password w23e
INSERT INTO DBAS.usuarios(id_usuario,username,password)
VALUES (@id_p,'admin','5rhwUL/LgUP8uNsBcKTcntANkE3dPipK0bHo3A/cm+c=')
GO

-- Se le asigna el rol administrador general al usuario admin
INSERT INTO DBAS.usuariosPorRol(id_usuario, id_rol)
SELECT tablaUsuarios.id_usuario, tablaRoles.id_rol FROM DBAS.usuarios tablaUsuarios, DBAS.roles tablaRoles
WHERE tablaRoles.nombre_rol = 'Administrador General' and tablaUsuarios.username = 'admin'
GO

CREATE FUNCTION DBAS.Top5DeLosDestinosConMasPasajesComprados(@semestreDelAnio tinyint, @anio integer)
RETURNS @TOP5 TABLE ( ciudad_origen varchar(100), ciudad_destino varchar(100), pasajes_comprados bigint)
AS
BEGIN

	DECLARE @anioDelSemestre datetime
	SET @anioDelSemestre = convert(datetime, concat(@anio, '0701 00:00:00.000'))

	IF (@semestreDelAnio = 1)
	BEGIN

		INSERT INTO @TOP5(ciudad_origen, ciudad_destino, pasajes_comprados)
		SELECT TOP 5 tablaCiudades1.nombre_ciudad, tablaCiudades2.nombre_ciudad, COUNT(tablaPE.codigo_PE) as pasajes_comprados FROM (SELECT * FROM DBAS.pasajesEncomiendas WHERE encomienda_cliente_KG = 0) tablaPE, DBAS.viajes tablaViajes, DBAS.rutas tablaRutas, DBAS.ciudades tablaCiudades1, DBAS.ciudades tablaCiudades2
		WHERE tablaPE.id_viaje = tablaViajes.id_viaje AND tablaViajes.codigo_ruta = tablaRutas.codigo_ruta AND tablaCiudades1.id_ciudad = tablaRutas.ciudad_origen_id AND tablaCiudades2.id_ciudad = tablaRutas.ciudad_destino_id
			AND tablaPE.fecha_compra_pasaje <  @anioDelSemestre AND DATEPART(year,tablaPE.fecha_compra_pasaje) = DATEPART(year,@anioDelSemestre)
		GROUP BY tablaCiudades1.nombre_ciudad, tablaCiudades2.nombre_ciudad
		ORDER BY pasajes_comprados DESC

		
	END
	ELSE
		BEGIN

			INSERT INTO @TOP5(ciudad_origen, ciudad_destino, pasajes_comprados)
			SELECT TOP 5 tablaCiudades1.nombre_ciudad, tablaCiudades2.nombre_ciudad, COUNT(tablaPE.codigo_PE) as pasajes_comprados FROM DBAS.pasajesEncomiendas tablaPE, DBAS.viajes tablaViajes, DBAS.rutas tablaRutas, DBAS.ciudades tablaCiudades1, DBAS.ciudades tablaCiudades2
			WHERE tablaPE.id_viaje = tablaViajes.id_viaje AND tablaViajes.codigo_ruta = tablaRutas.codigo_ruta AND tablaCiudades1.id_ciudad = tablaRutas.ciudad_origen_id AND tablaCiudades2.id_ciudad = tablaRutas.ciudad_destino_id
			AND tablaPE.fecha_compra_pasaje >=  @anioDelSemestre AND DATEPART(year,tablaPE.fecha_compra_pasaje) = DATEPART(year,@anioDelSemestre)
			GROUP BY tablaCiudades1.nombre_ciudad, tablaCiudades2.nombre_ciudad
			ORDER BY pasajes_comprados DESC

		END

	RETURN
END;	
GO

/*
	SELECT  tablaCiudades1.nombre_ciudad, tablaCiudades2.nombre_ciudad, tablaAeronaves.matricula_aeronave, (SUM(tablaPE.encomienda_cliente_KG)) as kg_libres FROM DBAS.pasajesEncomiendas tablaPE, DBAS.viajes tablaViajes, DBAS.rutas tablaRutas, DBAS.ciudades tablaCiudades1, DBAS.ciudades tablaCiudades2, DBAS.butacas tablaButacas, DBAS.aeronaves tablaAeronaves
	WHERE tablaPE.id_viaje = tablaViajes.id_viaje AND tablaViajes.codigo_ruta = tablaRutas.codigo_ruta AND tablaCiudades1.id_ciudad = tablaRutas.ciudad_origen_id  AND tablaCiudades2.id_ciudad = tablaRutas.ciudad_destino_id AND tablaPE.id_butaca = tablaButacas.id_butaca AND tablaButacas.matricula_aeronave = tablaAeronaves.matricula_aeronave
	GROUP BY tablaCiudades1.nombre_ciudad, tablaCiudades2.nombre_ciudad, tablaAeronaves.matricula_aeronave
	ORDER BY kg_libres
	RETURN
	*/

CREATE FUNCTION DBAS.obtenerFuncionalidadesAsociadas(@nombreRol varchar(100))
RETURNS TABLE
AS
RETURN
(
	SELECT tablaFuncionalidades.descripcion FROM ((SELECT * FROM DBAS.roles WHERE nombre_rol = @nombreRol) unRol 
		JOIN DBAS.rolesPorFuncionalidad tablaRpF ON (unRol.id_rol = tablaRpF.id_rol)
		JOIN DBAS.funcionalidades tablaFuncionalidades ON (tablaFuncionalidades.id_funcionalidad = tablaRpF.id_funcionalidad))
);
GO

/*
SELECT * FROM DBAS.obtenerFuncionalidadesAsociadas('Administrador General')
GO
*/

CREATE PROCEDURE DBAS.logginUsuario(@usuario varchar(100), @pass varchar(100))
AS
BEGIN
	DECLARE @U_id bigint
	DECLARE @U_password varchar(100)
	DECLARE @U_habilitado tinyint
	DECLARE @U_rol_id bigint
	DECLARE @cantidad_intentos tinyint
	DECLARE @mensaje_error varchar(100)
	DECLARE @nombre_rol varchar(100)

	SELECT @U_id = id_usuario, @U_password = password, @U_habilitado = habilitado, @cantidad_intentos = intentos_fallidos, @U_rol_id = id_rol FROM DBAS.usuarios WHERE username = @usuario
	IF (@U_id != NULL)
	BEGIN
		IF(@U_habilitado != 1)
		BEGIN
			SET @mensaje_error = 'El usuario ingresado se encuentra deshabilitado'
			RAISERROR(@mensaje_error, 12, 1)
		END
		ELSE
		BEGIN
			IF(@U_password != @pass)
			BEGIN
				IF(@cantidad_intentos < 2)
				BEGIN
					UPDATE DBAS.usuarios SET intentos_fallidos = @cantidad_intentos + 1  WHERE username = @usuario
					SET @mensaje_error = 'Password invalida'
					RAISERROR(@mensaje_error, 12, 1)
				END
				ELSE
				BEGIN
					UPDATE DBAS.usuarios SET intentos_fallidos = @cantidad_intentos + 1, habilitado = 0   WHERE username = @usuario
					SET @mensaje_error = 'Password invalida, alcanzo la cantidad de intentos maximos. Se desactivara la cuenta por seguridad'
					RAISERROR(@mensaje_error, 12, 1)
				END
			END
			ELSE
			BEGIN
				UPDATE DBAS.usuarios SET intentos_fallidos = 0  WHERE username = @usuario

				SELECT @nombre_rol = nombre_rol FROM DBAS.roles WHERE id_rol = @U_rol_id
				SELECT * FROM DBAS.obtenerFuncionalidadesAsociadas(@nombre_rol)
			END
		END
	END
	ELSE
	BEGIN
		SET @mensaje_error = 'El usuario ingresado no existe'
		RAISERROR(@mensaje_error, 12, 1)
	END
END;
GO

/*
CREATE PROCEDURE DBAS.altaRol(@nombre_rol varchar(100), @nombre_funcionalidades varchar(100))
AS
BEGIN
	DECLARE @mensaje_error varchar(100)

*/
